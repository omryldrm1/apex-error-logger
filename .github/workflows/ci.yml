name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Show CLI version
        run: sf --version

      - name: Validate project manifest
        run: sf project generate manifest --source-dir force-app --name ci-generated --output-dir manifest

      - name: Auth to Salesforce (optional)
        if: ${{ secrets.SF_AUTH_URL != '' }}
        run: |
          echo "${{ secrets.SF_AUTH_URL }}" > sfdx_auth_url.txt
          sf org login sfdx-url --sfdx-url-file sfdx_auth_url.txt --alias CI --set-default

      - name: Deploy metadata (validate only)
        if: ${{ secrets.SF_AUTH_URL != '' }}
        run: sf project deploy start --manifest manifest/package.xml --target-org CI --test-level RunLocalTests --ignore-conflicts --dry-run

      - name: Run Apex tests
        if: ${{ secrets.SF_AUTH_URL != '' }}
        run: sf apex test run --target-org CI --wait 60 --result-format human --code-coverage --output-dir test-results

      - name: Archive test results
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results
